#include <SPI.h>
#include <SD.h>

const int tempPin = A0;       // LM35 sensor pin
const int chipSelect = 10;    // SD card module CS pin

File dataFile;

void setup() {
  Serial.begin(9600);
  while (!Serial) {
    ; // wait for serial port to connect (only needed for some boards)
  }

  Serial.print("Initializing SD card...");
  if (!SD.begin(chipSelect)) {
    Serial.println("Initialization failed!");
    while (1);
  }
  Serial.println("Initialization done.");

  // Open/create the file "datalog.csv" and write header if empty
  dataFile = SD.open("datalog.csv", FILE_WRITE);
  if (dataFile) {
    // Check if file is empty by checking size
    if (dataFile.size() == 0) {
      dataFile.println("Time(s),Temperature(C)");  // Write CSV header
    }
    dataFile.close();
  } else {
    Serial.println("Error opening datalog.csv");
  }
}

void loop() {
  int analogValue = analogRead(tempPin);
  float voltage = analogValue * (5.0 / 1023.0);
  float temperatureC = voltage * 100.0;

  unsigned long seconds = millis() / 1000;

  // Open the file again to append data
  dataFile = SD.open("datalog.csv", FILE_WRITE);
  if (dataFile) {
    dataFile.print(seconds);
    dataFile.print(",");
    dataFile.println(temperatureC, 2);
    dataFile.close();
    Serial.print("Logged: ");
    Serial.print(seconds);
    Serial.print(",");
    Serial.println(temperatureC, 2);
  } else {
    Serial.println("Error opening datalog.csv");
  }

  delay(1000);
}
